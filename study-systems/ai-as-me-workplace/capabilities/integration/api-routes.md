# API路由配置

**最后更新**：2026-01-16  
**版本**：v2.0

---

## 路由说明

本文件定义了用户请求到AI能力的路由规则，包括能力选择、组合和调用链管理。

---

## 路由规则

### 按请求类型路由

| 请求类型 | 匹配模式 | 目标能力 | 优先级 | 说明 |
|---------|---------|---------|--------|------|
| 文档处理 | "生成.*文档" | [能力ID] | P0 | [说明] |
| 数据分析 | "分析.*数据" | [能力ID] | P0 | [说明] |
| 代码生成 | "生成.*代码" | [能力ID] | P0 | [说明] |
| 项目管理 | "管理.*项目" | [能力ID] | P0 | [说明] |
| 团队协作 | "协作.*团队" | [能力ID] | P0 | [说明] |

### 按关键词路由

| 关键词 | 匹配模式 | 目标能力 | 优先级 | 说明 |
|--------|---------|---------|--------|------|
| FMEA | ".*FMEA.*" | [能力ID] | P0 | [说明] |
| FTA | ".*FTA.*" | [能力ID] | P0 | [说明] |
| 安全计划 | ".*安全计划.*" | [能力ID] | P0 | [说明] |
| 转换为Word | ".*转换为.*Word.*|.*转.*Word.*|.*生成.*Word.*" | TOOL-001 | P0 | Pandoc文档转换 |
| 转换为PDF | ".*转换为.*PDF.*|.*转.*PDF.*|.*生成.*PDF.*" | TOOL-001 | P0 | Pandoc文档转换 |
| 导出Word | ".*导出.*Word.*|.*导出为.*Word.*" | TOOL-001 | P0 | Pandoc文档转换 |
| 导出PDF | ".*导出.*PDF.*|.*导出为.*PDF.*" | TOOL-001 | P0 | Pandoc文档转换 |
| 飞书消息 | ".*飞书.*消息.*|.*发送.*飞书.*|.*飞书.*通讯.*" | MCP-001/SKILL-001 | P0 | 飞书API集成 |
| 飞书Wiki | ".*飞书.*Wiki.*|.*飞书.*云文档.*|.*飞书.*文档.*" | MCP-001/SKILL-001 | P0 | 飞书API集成 |
| 飞书表格 | ".*飞书.*表格.*|.*飞书.*在线表格.*|.*飞书.*多维表格.*" | MCP-001/SKILL-001 | P0 | 飞书API集成 |
| 飞书项目 | ".*飞书.*项目.*|.*飞书.*工作项.*|.*飞书.*流程.*" | MCP-001/SKILL-001 | P0 | 飞书API集成 |
| 飞书表格更新 | ".*飞书.*表格.*更新.*|.*飞书.*多维表格.*更新.*|.*飞书.*今日更新.*" | SKILL-002 | P0 | 飞书多维表格今日更新总结 |
| 飞书更新总结 | ".*飞书.*更新.*总结.*|.*飞书.*更新记录.*" | SKILL-002 | P0 | 飞书多维表格今日更新总结 |

### 按场景路由

| 场景 | 匹配条件 | 目标能力 | 优先级 | 说明 |
|------|---------|---------|--------|------|
| 技术分析 | [条件] | [能力ID] | P0 | [说明] |
| 文档编写 | [条件] | [能力ID] | P0 | [说明] |
| 团队管理 | [条件] | [能力ID] | P0 | [说明] |
| 客户对接 | [条件] | [能力ID] | P0 | [说明] |

---

## 能力组合

### 组合策略

#### 组合1：[组合名称]
- **能力列表**：[能力ID列表]
- **适用场景**：[场景描述]
- **组合顺序**：[顺序说明]
- **组合效果**：[效果描述]

#### 组合2：[组合名称]
- **能力列表**：[能力ID列表]
- **适用场景**：[场景描述]
- **组合顺序**：[顺序说明]
- **组合效果**：[效果描述]

---

## 调用链

### 调用链1：故障信息查询
- **场景**：通过单号查询故障信息
- **能力序列**：fault_ticket_monitor → bitable_query → fault_query
- **调用流程**：
  1. 获取问题单信息 - fault_ticket_monitor - 根据单号获取问题单基本信息
  2. 从多维表格获取数据 - bitable_query - 获取缺陷表格数据
  3. 查询故障信息 - fault_query - 整合信息并分析
- **工作流模板**：fault_query_workflow

### 调用链2：数据分析工作流
- **场景**：从多维表格加载数据并进行分析
- **能力序列**：bitable_cache → bitable_query → report_generator
- **调用流程**：
  1. 加载多维表格数据 - bitable_cache - 从缓存或API加载数据
  2. 数据查询和分析 - bitable_query - 进行数据分析和查询
  3. 生成分析报告 - report_generator - 生成分析报告
- **工作流模板**：data_analysis_workflow

### 调用链3：文档生成工作流
- **场景**：基于数据生成文档并同步到飞书
- **能力序列**：data_loader → doc_generator → feishu_doc
- **调用流程**：
  1. 加载数据 - data_loader - 从数据源加载数据
  2. 生成文档内容 - doc_generator - 基于模板生成文档
  3. 同步到飞书 - feishu_doc - 同步文档到飞书Wiki
- **工作流模板**：document_generation_workflow

---

## 工作流路由

### 工作流模板路由

| 查询模式 | 工作流模板 | 参数 | 优先级 | 说明 |
|---------|-----------|------|--------|------|
| "查询.*故障.*信息" \| ".*单号.*查询" | fault_query_workflow | ticket_id | P0 | 通过单号查询故障信息 |
| "分析.*数据" \| ".*数据分析" | data_analysis_workflow | table_name, cache_file | P0 | 数据分析工作流 |
| "生成.*文档" \| ".*文档生成" | document_generation_workflow | data_source, doc_template | P0 | 文档生成工作流 |

### 工作流执行

工作流通过 `TemplateEngine` 执行：

```python
from capabilities.templates.template_engine import TemplateEngine

engine = TemplateEngine()
result = engine.execute_template(
    "fault_query_workflow",
    parameters={"ticket_id": "6683487902"}
)
```

---

## 智能路由

### 路由策略
- **优先级策略**：根据优先级选择能力
- **上下文策略**：根据工作上下文选择能力
- **历史策略**：根据历史使用记录选择能力
- **效果策略**：根据使用效果选择能力

### 路由决策流程
1. **请求分析**：分析用户请求类型、关键词、场景
2. **能力匹配**：从注册表匹配可用能力
3. **能力选择**：根据路由策略选择能力
4. **能力调用**：调用选定的能力
5. **结果处理**：处理能力返回结果

---

## 路由配置

### 默认路由
- **默认能力**：[能力ID]
- **默认策略**：[策略名称]

### 自定义路由
- **用户自定义路由**：[路由规则]

---

## 路由优化

### 优化策略
- [策略1]：[描述]
- [策略2]：[描述]

### 优化记录
| 日期 | 优化内容 | 效果 | 说明 |
|------|---------|------|------|
| YYYY-MM-DD | [内容] | [效果] | [说明] |

---

## 关联记录

### 相关注册表
- [注册表链接]

### 相关使用记录
- [使用记录链接]

### 相关集成配置
- [集成配置链接]
