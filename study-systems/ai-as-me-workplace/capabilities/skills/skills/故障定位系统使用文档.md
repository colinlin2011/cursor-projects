# Fault ID自动故障定位与闭环系统使用文档

## 系统概述

本系统实现了从缺陷问题单到故障定位的完整自动化流程：

1. **监控问题单**：自动监控"缺陷问题闭环表"的新增记录
2. **提取日志路径**：从问题单的描述和Ticket元信息中提取日志路径
3. **获取日志数据**：通过SSH连接服务器下载日志文件
4. **提取Fault ID**：从日志中提取Fault ID（支持多种格式）
5. **查询故障指引**：根据Fault ID从飞书Wiki查询故障定位指引
6. **分析日志**：使用AI分析日志内容，生成结构化分析报告
7. **回填结果**：将分析结果自动回填到问题单的"工具回传"字段

## 系统架构

### 核心模块

1. **配置管理模块** (`fault_diagnosis_config.py`)
   - 管理所有配置项：表名、字段映射、SSH配置、监控配置等

2. **问题单监控模块** (`fault_ticket_monitor.py`)
   - 监控新增问题单
   - 支持自动监控和手动触发
   - 去重处理，避免重复处理

3. **日志路径提取模块** (`log_path_extractor.py`)
   - 从问题单多个字段中提取日志路径
   - 支持多种路径格式识别

4. **日志获取与Fault ID提取模块** (`log_fault_id_extractor.py`)
   - 通过SSH连接服务器获取日志
   - 根据指引提取Fault ID

5. **故障定位指引读取模块** (`fault_guide_reader.py`)
   - 从飞书Wiki读取故障定位指引文档
   - 解析结构化表格，建立Fault ID映射

6. **日志分析模块** (`log_analyzer.py`)
   - 根据故障定位指引分析日志
   - 使用AI进行智能分析
   - 生成结构化分析报告

7. **结果回填模块** (`fault_result_writer.py`)
   - 将分析结果回填到缺陷问题闭环表

8. **主流程控制器** (`auto_fault_diagnosis.py`)
   - 整合所有模块，实现完整业务流程

## 安装依赖

```bash
pip install paramiko
```

其他依赖（如`feishu_api_wrapper`、`feishu_bitable_collaborator`等）应该已经存在于项目中。

## 配置说明

### 环境变量

在运行系统前，需要设置以下环境变量：

```bash
# Windows PowerShell
$env:FEISHU_USER_ACCESS_TOKEN="u-xxxxxxxxxxxxx"

# Linux/Mac
export FEISHU_USER_ACCESS_TOKEN="u-xxxxxxxxxxxxx"
```

### SSH服务器配置

SSH服务器配置在`fault_diagnosis_config.py`中，支持通过环境变量覆盖：

```bash
# Windows PowerShell
$env:LOG_SERVER_HOST="10.241.120.91"
$env:LOG_SERVER_USER="dji"
$env:LOG_SERVER_PASSWORD="AutoXPC.246!"

# Linux/Mac
export LOG_SERVER_HOST="10.241.120.91"
export LOG_SERVER_USER="dji"
export LOG_SERVER_PASSWORD="AutoXPC.246!"
```

## 使用方式

### 方式1：自动监控模式

系统会自动监控"缺陷问题闭环表"的新增记录，每3小时检查一次（可在配置中修改）。

```python
from auto_fault_diagnosis import run_auto_monitor

# 启动自动监控（使用默认间隔：3小时）
run_auto_monitor()

# 或指定监控间隔（秒）
run_auto_monitor(interval=3600)  # 每1小时检查一次
```

**命令行方式**：

```bash
cd capabilities/skills/skills
python auto_fault_diagnosis.py --monitor
```

### 方式2：手动触发模式

处理指定的问题单：

```python
from auto_fault_diagnosis import process_ticket

# 处理指定问题单（使用记录ID或工作项ID）
result = process_ticket(ticket_id="recXXXXX")
# 或
result = process_ticket(ticket_id="工作项ID")

if result.get('success'):
    print("处理成功")
else:
    print(f"处理失败: {result.get('error')}")
```

**命令行方式**：

```bash
cd capabilities/skills/skills
python auto_fault_diagnosis.py --ticket recXXXXX
```

### 方式3：直接诊断模式

直接诊断Fault ID，不通过问题单：

```python
from auto_fault_diagnosis import process_fault_id

# 直接诊断Fault ID
result = process_fault_id(
    fault_id="0x0165",
    log_path="/rawdata/roadtestv3/BAIC/3R7V/roadtest/cn/2025/10/20251016/BAIC/"
)

if result.get('success'):
    print(result.get('report'))
```

**命令行方式**：

```bash
cd capabilities/skills/skills
python auto_fault_diagnosis.py --fault-id 0x0165 --log-path "/rawdata/roadtestv3/..."
```

## 工作流程

### 完整流程示例

```
1. 监控模块检测到新问题单
   ↓
2. 从问题单提取日志路径
   - 检查"描述"字段
   - 检查"Ticket 元信息"字段
   - 识别包含"/rawdata/"或"roadtest"的路径
   ↓
3. 通过SSH连接服务器下载日志
   - 连接: 10.241.120.91
   - 下载日志文件到本地缓存
   ↓
4. 从日志中提取Fault ID
   - 使用通用模式提取
   - 或根据故障定位指引的grep模式提取
   ↓
5. 查询故障定位指引
   - 从飞书Wiki加载指引文档
   - 根据Fault ID查找对应指引
   ↓
6. 分析日志内容
   - 提取关键错误信息
   - 分析时间线
   - 识别涉及模块
   - 生成初步结论
   ↓
7. 生成分析报告
   - 故障信息
   - 关键错误
   - 分析要点
   - 初步结论
   ↓
8. 回填结果到问题单
   - 更新"工具回传"字段
   - 标记为已处理
```

## 配置项说明

### 字段映射

在`fault_diagnosis_config.py`中配置：

```python
FIELD_MAPPING = {
    "描述": "描述",
    "Ticket元信息": "Ticket 元信息",
    "工作项id": "工作项id",
    "工具回传": "工具回传",  # 用于回填分析结果
    "Fault_ID": "Fault_ID",
    "Fault ID": "Fault ID"
}
```

### 监控配置

```python
MONITOR_CONFIG = {
    "interval_seconds": 3 * 3600,  # 3小时
    "check_new_work_item_id": True,  # 检查新增的"工作项id"
    "deduplicate": True,  # 去重处理
    "processed_items_file": "work/fault_diagnosis_processed_items.json"
}
```

### 故障定位指引文档

```python
FAULT_GUIDE_DOCS = [
    {
        "name": "故障定位指引文档1",
        "node_token": "UBS2wO9aai7jB7kaw4QcQGNbngc",
        "url": "https://zyt.feishu.cn/wiki/UBS2wO9aai7jB7kaw4QcQGNbngc"
    },
    # ... 更多文档
]
```

## 故障排查

### 1. SSH连接失败

**问题**：无法连接到日志服务器

**解决方案**：
- 检查SSH服务器地址和端口
- 确认用户名和密码正确
- 检查网络连接
- 确认服务器防火墙设置

### 2. 无法提取日志路径

**问题**：从问题单中无法提取到日志路径

**解决方案**：
- 检查问题单的"描述"和"Ticket 元信息"字段是否包含路径信息
- 确认路径格式包含关键字：`/rawdata/`、`roadtest`、`/bench-log/`
- 可以手动指定日志路径使用直接诊断模式

### 3. 无法提取Fault ID

**问题**：从日志中无法提取到Fault ID

**解决方案**：
- 检查日志文件是否下载成功
- 确认日志中包含Fault ID信息
- 检查Fault ID格式是否支持（支持：0x0165、165、0x165等）
- 可以手动指定Fault ID使用直接诊断模式

### 4. 无法查询故障定位指引

**问题**：无法从飞书Wiki获取故障定位指引

**解决方案**：
- 检查`FEISHU_USER_ACCESS_TOKEN`是否有效
- 确认指引文档的node_token正确
- 检查用户是否有权限访问Wiki文档
- 查看缓存文件：`work/fault_diagnosis_cache/guides/`

### 5. 结果回填失败

**问题**：无法将分析结果回填到问题单

**解决方案**：
- 检查`FEISHU_USER_ACCESS_TOKEN`是否有效
- 确认用户有权限修改问题单
- 检查"工具回传"字段是否存在
- 确认字段类型支持文本内容

## 日志和缓存

### 缓存目录

系统会在以下目录创建缓存：

```
work/fault_diagnosis_cache/
├── logs/          # 日志文件缓存
└── guides/        # 故障定位指引缓存
```

### 已处理记录

已处理的问题单ID保存在：

```
work/fault_diagnosis_processed_items.json
```

## 示例

### 示例1：处理单个问题单

```python
from auto_fault_diagnosis import process_ticket

# 处理问题单
result = process_ticket("recABC123")

# 查看处理结果
if result.get('success'):
    print("处理成功")
    for step in result.get('steps', []):
        print(f"步骤 {step.get('step')}: {'成功' if step.get('success') else '失败'}")
else:
    print(f"处理失败: {result.get('error')}")
```

### 示例2：直接诊断Fault ID

```python
from auto_fault_diagnosis import process_fault_id

# 诊断Fault ID 165
result = process_fault_id(
    fault_id="0x0165",
    log_path="/rawdata/roadtestv3/BAIC/3R7V/roadtest/cn/2025/10/20251016/BAIC/"
)

# 查看分析报告
if result.get('success'):
    print(result.get('report'))
```

### 示例3：加载故障定位指引

```python
from fault_guide_reader import get_guide_reader

# 获取指引读取器
reader = get_guide_reader()

# 加载所有指引文档
reader.load_all_guides()

# 查询特定Fault ID的指引
guide_info = reader.get_guide_by_fault_id("0x0165")
if guide_info:
    print(f"故障名称: {guide_info.get('故障名称')}")
    print(f"grep模式: {guide_info.get('grep_pattern')}")
```

## 注意事项

1. **Token有效期**：`FEISHU_USER_ACCESS_TOKEN`通常有效期为2小时，过期后需要重新获取
2. **SSH连接**：系统会自动管理SSH连接，处理完成后会断开
3. **缓存机制**：故障定位指引文档会缓存24小时，日志文件会缓存到本地
4. **去重机制**：系统会自动记录已处理的问题单，避免重复处理
5. **错误处理**：系统包含完整的错误处理机制，失败时会输出详细错误信息

## 扩展开发

### 添加新的故障定位指引文档

在`fault_diagnosis_config.py`中添加：

```python
FAULT_GUIDE_DOCS.append({
    "name": "新指引文档",
    "node_token": "新文档的node_token",
    "url": "文档URL"
})
```

### 自定义日志分析逻辑

修改`log_analyzer.py`中的`analyze_log_by_guide`方法，添加自定义分析逻辑。

### 自定义结果回填格式

修改`fault_result_writer.py`中的`format_report_for_bitable`方法，自定义报告格式。

## 技术支持

如有问题，请检查：
1. 日志输出信息
2. 缓存文件内容
3. 错误堆栈信息
4. 配置文件设置
