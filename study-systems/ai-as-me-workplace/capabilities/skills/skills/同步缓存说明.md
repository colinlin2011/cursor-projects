# 同步过往交互需要的缓存内容

## 概述

根据已建立的飞书能力，需要同步以下缓存内容：

### 1. 多维表格缓存
- **功能安全部人力盘点** (`CGMnwhxzLixWhGk87jYcDRfonsh`)
- **新多维表格（功能安全业务数据）** (`BPddwBxoRiPFSsk8jZJctCMmndg`)

### 2. 在线表格缓存
- **在线表格示例** (`TDlnwRfpBikbUIk5guDcRyN5neh`)

---

## 快速同步步骤

### 方式1：自动同步（推荐，含Token自动刷新）

**首次授权（仅需一次）：**
```bash
python get_user_token_for_bitable.py
```

**启动自动同步服务：**
```bash
python auto_sync_all.py
```

系统会自动：
- 自动刷新访问令牌（Token过期前自动刷新）
- 定时同步所有缓存（默认每小时）
- 无需人工干预

**一次性同步：**
```bash
python auto_sync_all.py --once
```

**强制刷新：**
```bash
python auto_sync_all.py --once --force
```

详细说明请参考：`自动同步使用说明.md`

---

### 方式2：手动同步

### 步骤1：安装依赖

确保已安装必要的Python包：

```bash
pip install requests
```

如果需要使用自动同步功能，还需要：

```bash
pip install schedule
```

### 步骤2：设置环境变量（可选）

如果访问令牌已过期，需要设置新的访问令牌：

**PowerShell:**
```powershell
$env:FEISHU_USER_ACCESS_TOKEN="your_token_here"
```

**CMD:**
```cmd
set FEISHU_USER_ACCESS_TOKEN=your_token_here
```

### 步骤3：执行同步

#### 方式1：使用快速同步脚本（推荐）

```bash
cd "P:\Cursor Project\study-systems\ai-as-me-workplace\capabilities\skills\skills"
python sync_cache_now.py
```

这个脚本会：
- 自动获取并刷新访问令牌
- 同步所有配置的多维表格缓存
- 同步所有配置的在线表格缓存
- 显示同步结果和统计信息

#### 方式2：分别同步

**同步多维表格：**
```bash
python auto_sync_bitable.py --once
```

**同步在线表格：**
```bash
python auto_sync_spreadsheet.py --once
```

#### 方式3：使用缓存管理器直接同步

**多维表格：**
```python
from bitable_cache_manager import BitableCacheManager, BITABLE_CONFIGS, APP_ID, APP_SECRET, USER_ACCESS_TOKEN, SPACE_ID

manager = BitableCacheManager(APP_ID, APP_SECRET, USER_ACCESS_TOKEN, SPACE_ID)
results = manager.sync_all_bitables(force_refresh=True)
```

**在线表格：**
```python
from spreadsheet_cache_manager import SpreadsheetCacheManager, SPREADSHEET_CONFIGS, APP_ID, APP_SECRET, USER_ACCESS_TOKEN, SPACE_ID

manager = SpreadsheetCacheManager(APP_ID, APP_SECRET, USER_ACCESS_TOKEN, SPACE_ID)
results = manager.sync_all_spreadsheets(force_refresh=True)
```

---

## 缓存文件位置

### 多维表格缓存
- 缓存目录：`work/bitable_cache/`
- 配置文件：`work/bitable_cache/cache_config.json`
- 缓存文件：
  - `work/bitable_cache/hr_inventory.json` - 功能安全部人力盘点
  - `work/bitable_cache/new_bitable.json` - 新多维表格

### 在线表格缓存
- 缓存目录：`work/spreadsheet_cache/`
- 配置文件：`work/spreadsheet_cache/cache_config.json`
- 缓存文件：
  - `work/spreadsheet_cache/spreadsheet_example.json` - 在线表格示例

---

## 验证同步结果

### 检查多维表格缓存

```python
from bitable_query_interface import get_query_interface

interface = get_query_interface()
summary = interface.get_cache_summary()
print(summary)
```

### 检查在线表格缓存

```python
from spreadsheet_query_interface import get_query_interface

interface = get_query_interface()
summary = interface.get_cache_summary()
print(summary)
```

### 使用检查脚本

**检查多维表格记录数：**
```bash
python check_cache_records.py
```

**查询缺陷问题闭环表：**
```bash
python query_defect_table.py
```

---

## 已配置的表格

### 多维表格配置（BITABLE_CONFIGS）

1. **功能安全部人力盘点**
   - Node Token: `CGMnwhxzLixWhGk87jYcDRfonsh`
   - URL: `https://zyt.feishu.cn/wiki/CGMnwhxzLixWhGk87jYcDRfonsh`
   - 缓存文件: `hr_inventory.json`

2. **新多维表格（功能安全业务数据）**
   - Node Token: `BPddwBxoRiPFSsk8jZJctCMmndg`
   - URL: `https://zyt.feishu.cn/wiki/BPddwBxoRiPFSsk8jZJctCMmndg`
   - 缓存文件: `new_bitable.json`
   - 包含"缺陷问题闭环表"（应有253条记录）

### 在线表格配置（SPREADSHEET_CONFIGS）

1. **在线表格示例**
   - Node Token: `TDlnwRfpBikbUIk5guDcRyN5neh`
   - URL: `https://zyt.feishu.cn/wiki/TDlnwRfpBikbUIk5guDcRyN5neh`
   - 缓存文件: `spreadsheet_example.json`

---

## 注意事项

1. **访问令牌有效期**：访问令牌有效期约2小时，过期后需要重新获取
2. **同步间隔**：默认同步间隔为1小时，可以通过`--interval`参数自定义
3. **强制刷新**：使用`force_refresh=True`会忽略缓存过期时间，强制从API获取最新数据
4. **网络连接**：确保网络连接正常，能够访问飞书API
5. **权限要求**：确保应用有相应的权限（多维表格、在线表格等）

---

## 相关文件

- `sync_cache_now.py` - 快速同步脚本（新建）
- `auto_sync_bitable.py` - 多维表格自动同步脚本
- `auto_sync_spreadsheet.py` - 在线表格自动同步脚本
- `bitable_cache_manager.py` - 多维表格缓存管理器
- `spreadsheet_cache_manager.py` - 在线表格缓存管理器
- `bitable_query_interface.py` - 多维表格查询接口
- `spreadsheet_query_interface.py` - 在线表格查询接口
- `同步功能安全业务数据说明.md` - 功能安全业务数据同步说明

---

## 故障排查

### 问题1：ModuleNotFoundError: No module named 'requests'

**解决方案**：
```bash
pip install requests
```

### 问题2：访问令牌过期

**解决方案**：
1. 获取新的访问令牌（参考`获取Token操作指南.md`）
2. 设置环境变量：`$env:FEISHU_USER_ACCESS_TOKEN="new_token"`

### 问题3：权限不足

**解决方案**：
- 检查应用权限配置
- 参考`FEISHU-WIKI-PERMISSION-SETUP.md`和`FEISHU-USER-TOKEN-PERMISSION.md`

### 问题4：同步失败

**解决方案**：
- 检查网络连接
- 检查API配置（APP_ID、APP_SECRET等）
- 查看错误信息，参考相关文档

---

## 更新记录

- **2026-01-16**：创建同步缓存说明文档
- **2026-01-16**：创建快速同步脚本 `sync_cache_now.py`
- **2026-01-16**：建立自动同步系统（含Token自动刷新）
  - 创建统一同步脚本 `auto_sync_all.py`
  - 更新所有同步脚本集成token自动刷新
  - 创建自动同步使用说明文档