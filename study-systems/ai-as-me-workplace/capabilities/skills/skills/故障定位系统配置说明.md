# 故障定位系统配置说明

## 1. 添加新的故障定位指引文档

### 方法1：通过配置文件添加（推荐）

编辑 `work/fault_diagnosis_guides_config.json` 文件，添加新的指引文档：

```json
{
  "guide_docs": [
    {
      "name": "故障定位指引文档1",
      "node_token": "UBS2wO9aai7jB7kaw4QcQGNbngc",
      "url": "https://zyt.feishu.cn/wiki/UBS2wO9aai7jB7kaw4QcQGNbngc"
    },
    {
      "name": "新故障定位指引文档",
      "node_token": "新文档的node_token",
      "url": "https://zyt.feishu.cn/wiki/新文档的node_token"
    }
  ]
}
```

**说明**：
- `name`: 文档名称（用于显示）
- `node_token`: 从飞书Wiki文档URL中提取（URL中最后一个斜杠后的部分）
- `url`: 完整的文档URL

系统会自动读取该配置文件，无需修改代码。

### 方法2：在代码中直接添加

如果配置文件不存在，系统会使用 `fault_diagnosis_config.py` 中的默认配置。可以直接在该文件中添加：

```python
FAULT_GUIDE_DOCS = [
    # ... 现有文档 ...
    {
        "name": "新故障定位指引文档",
        "node_token": "新文档的node_token",
        "url": "https://zyt.feishu.cn/wiki/新文档的node_token"
    }
]
```

## 2. 指引文档缓存机制

### 缓存位置

指引文档缓存保存在：`work/fault_diagnosis_cache/guides/`

每个文档的缓存文件格式：`guide_{node_token}.json`

### 缓存有效期

- 默认缓存有效期：**24小时**
- 缓存过期后，系统会自动从Wiki重新加载

### 手动刷新缓存

```python
from fault_guide_reader import get_guide_reader

reader = get_guide_reader()
reader.refresh_all_guides_if_needed(max_cache_age_hours=24)  # 24小时刷新一次
```

### 强制刷新所有缓存

```python
from fault_guide_reader import get_guide_reader

reader = get_guide_reader()
reader.load_all_guides(force_refresh=True)  # 强制刷新
```

## 3. Token自动刷新机制

### 首次授权

运行 `get_user_token_for_bitable.py` 获取token：

```bash
cd capabilities/skills/skills
python get_user_token_for_bitable.py
```

系统会自动：
1. 保存 `access_token` 和 `refresh_token` 到缓存
2. 记录token有效期
3. 启用自动刷新功能

### 自动刷新

系统会在以下情况自动刷新token：
- Token即将过期（提前5分钟）
- 每次使用token时检查有效期

### Token缓存位置

Token缓存保存在：`work/fault_diagnosis_token_cache.json`

### 手动刷新Token

如果自动刷新失败，可以：

1. **重新运行授权脚本**：
   ```bash
   python get_user_token_for_bitable.py
   ```

2. **设置环境变量**（临时使用）：
   ```powershell
   $env:FEISHU_USER_ACCESS_TOKEN="your_token"
   ```

### Refresh Token有效期

- `refresh_token` 有效期：**14天**
- 过期后需要重新授权

## 4. 配置文件说明

### 指引文档配置文件

**文件路径**：`work/fault_diagnosis_guides_config.json`

**格式**：
```json
{
  "guide_docs": [
    {
      "name": "文档名称",
      "node_token": "文档node_token",
      "url": "文档完整URL"
    }
  ]
}
```

### Token缓存文件

**文件路径**：`work/fault_diagnosis_token_cache.json`

**格式**：
```json
{
  "access_token": "u-xxxxx",
  "expires_at": 1234567890.0,
  "refresh_token": "refresh_xxxxx",
  "last_refresh": "2025-01-15T10:30:00"
}
```

## 5. 使用示例

### 添加新指引文档

1. 打开 `work/fault_diagnosis_guides_config.json`
2. 添加新文档配置
3. 保存文件
4. 系统下次使用时自动加载

### 检查Token状态

```python
from token_manager import get_token_manager

manager = get_token_manager()
token = manager.get_valid_user_access_token()
if token:
    print("Token有效")
else:
    print("需要重新授权")
```

### 刷新指引文档

```python
from fault_guide_reader import get_guide_reader

reader = get_guide_reader()
reader.refresh_all_guides_if_needed()
```

## 6. 故障排查

### 指引文档无法加载

1. 检查配置文件格式是否正确
2. 检查 `node_token` 是否正确
3. 检查是否有权限访问Wiki文档
4. 检查token是否有效

### Token刷新失败

1. 检查 `refresh_token` 是否过期（14天）
2. 如果过期，重新运行授权脚本
3. 检查网络连接
4. 查看错误日志

### 缓存问题

1. 删除缓存文件强制刷新：
   ```bash
   # 删除指引文档缓存
   rm work/fault_diagnosis_cache/guides/*.json
   
   # 删除token缓存（需要重新授权）
   rm work/fault_diagnosis_token_cache.json
   ```

## 7. 注意事项

1. **配置文件优先级**：如果 `work/fault_diagnosis_guides_config.json` 存在，优先使用配置文件；否则使用代码中的默认配置。

2. **Token自动刷新**：系统会自动管理token，无需手动干预。只有在refresh_token过期（14天）后才需要重新授权。

3. **缓存机制**：指引文档缓存24小时，避免频繁访问API。如需立即更新，可以手动刷新。

4. **安全性**：Token缓存文件包含敏感信息，请妥善保管，不要提交到版本控制系统。
