# 自动同步缓存使用说明（含Token自动刷新）

## 概述

已建立完整的自动同步缓存系统，支持：
- ✅ **自动刷新访问令牌**：Token过期前自动刷新，无需手动操作
- ✅ **自动同步多维表格缓存**：定时同步多维表格数据
- ✅ **自动同步在线表格缓存**：定时同步在线表格数据
- ✅ **自动同步故障定位指引文档缓存**：定时同步故障定位指引文档
- ✅ **统一管理**：一个脚本同步所有缓存

---

## 快速开始

### 步骤1：首次授权（仅需一次）

首次使用需要获取访问令牌和刷新令牌：

```bash
cd "P:\Cursor Project\study-systems\ai-as-me-workplace\capabilities\skills\skills"
python get_user_token_for_bitable.py
```

按照提示完成授权，系统会自动：
- 保存 `access_token` 和 `refresh_token` 到缓存
- 记录token有效期
- 启用自动刷新功能

**Token缓存位置**：`work/fault_diagnosis_token_cache.json`

### 步骤2：执行同步

#### 方式1：使用统一同步脚本（推荐）

**一次性同步：**
```bash
python auto_sync_all.py --once
```

**启动定时同步服务（每小时）：**
```bash
python auto_sync_all.py
```

**强制刷新所有缓存：**
```bash
python auto_sync_all.py --once --force
```

**自定义同步间隔（每2小时）：**
```bash
python auto_sync_all.py --interval 2
```

#### 方式2：分别同步

**多维表格：**
```bash
python auto_sync_bitable.py --once
```

**在线表格：**
```bash
python auto_sync_spreadsheet.py --once
```

#### 方式3：快速同步脚本

```bash
python sync_cache_now.py
```

---

## 功能说明

### 1. Token自动刷新机制

#### 工作原理

1. **首次授权**：运行 `get_user_token_for_bitable.py` 获取token并保存
2. **自动检查**：每次使用token时检查有效期
3. **自动刷新**：Token过期前5分钟自动刷新
4. **缓存保存**：刷新后的新token自动保存到缓存

#### Token缓存格式

```json
{
  "access_token": "u-xxxxx",
  "expires_at": 1234567890.0,
  "refresh_token": "refresh_xxxxx",
  "last_refresh": "2026-01-16T10:30:00"
}
```

#### Refresh Token有效期

- **有效期**：14天
- **过期后**：需要重新运行授权脚本获取新token

### 2. 自动同步机制

#### 同步内容

**多维表格缓存：**
- 功能安全部人力盘点
- 新多维表格（功能安全业务数据）

**在线表格缓存：**
- 在线表格示例

**故障定位指引文档缓存：**
- 故障定位指引文档1
- 故障定位指引文档2
- 故障定位指引文档3
- 故障定位指引文档4
- 故障定位指引文档5

#### 同步策略

- **默认策略**：检查缓存过期时间，未过期则跳过
- **强制刷新**：使用 `--force` 参数强制从API获取最新数据
- **同步间隔**：默认1小时，可通过 `--interval` 自定义

---

## 脚本说明

### auto_sync_all.py（推荐）

**功能**：统一同步所有缓存（多维表格 + 在线表格 + 故障定位指引文档）

**参数**：
- `--once`：只执行一次同步，不启动定时任务
- `--force`：强制刷新所有缓存（忽略过期时间）
- `--interval N`：设置同步间隔为N小时（默认1小时）

**示例**：
```bash
# 一次性同步
python auto_sync_all.py --once

# 启动定时同步（每小时）
python auto_sync_all.py

# 强制刷新并同步
python auto_sync_all.py --once --force

# 每2小时同步一次
python auto_sync_all.py --interval 2
```

### auto_sync_bitable.py

**功能**：仅同步多维表格缓存

**参数**：
- `--once`：只执行一次同步
- `--interval N`：设置同步间隔为N小时

**示例**：
```bash
python auto_sync_bitable.py --once
```

### auto_sync_spreadsheet.py

**功能**：仅同步在线表格缓存

**参数**：
- `--once`：只执行一次同步
- `--interval N`：设置同步间隔为N小时

**示例**：
```bash
python auto_sync_spreadsheet.py --once
```

### sync_cache_now.py

**功能**：快速同步所有缓存（一次性）

**特点**：
- 不依赖schedule模块
- 适合手动执行
- 自动获取并刷新token

**示例**：
```bash
python sync_cache_now.py
```

---

## 使用场景

### 场景1：日常使用（推荐）

启动定时同步服务，系统会自动：
- 每小时同步一次缓存
- Token过期前自动刷新
- 无需人工干预

```bash
python auto_sync_all.py
```

### 场景2：立即同步

需要立即获取最新数据时：

```bash
python auto_sync_all.py --once --force
```

### 场景3：首次设置

首次使用时的完整流程：

```bash
# 1. 获取token（仅需一次）
python get_user_token_for_bitable.py

# 2. 执行首次同步
python auto_sync_all.py --once --force

# 3. 启动定时同步服务
python auto_sync_all.py
```

---

## 故障排查

### 问题1：无法获取token

**症状**：提示"无法获取有效的访问令牌"

**解决方案**：
1. 运行授权脚本获取token：
   ```bash
   python get_user_token_for_bitable.py
   ```
2. 检查token缓存文件是否存在：`work/fault_diagnosis_token_cache.json`
3. 如果token已过期且refresh_token也过期，需要重新授权

### 问题2：Token刷新失败

**症状**：提示"Token刷新失败"

**可能原因**：
- Refresh token已过期（14天）
- 网络连接问题
- 应用权限变更

**解决方案**：
1. 重新运行授权脚本：
   ```bash
   python get_user_token_for_bitable.py
   ```
2. 检查网络连接
3. 检查应用权限配置

### 问题3：同步失败

**症状**：同步时出现错误

**解决方案**：
1. 检查token是否有效：
   ```python
   from token_manager import get_user_access_token
   token = get_user_access_token()
   if token:
       print("Token有效")
   else:
       print("需要重新授权")
   ```
2. 检查网络连接
3. 检查API配置（APP_ID、APP_SECRET等）
4. 查看详细错误信息

### 问题4：ModuleNotFoundError

**症状**：提示缺少模块（如requests、schedule）

**解决方案**：
```bash
pip install requests schedule
```

---

## 技术细节

### Token自动刷新流程

```
1. 调用 get_user_access_token()
   ↓
2. 检查缓存中的token
   ↓
3. 检查token有效期（提前5分钟）
   ↓
4. 如果即将过期，使用refresh_token刷新
   ↓
5. 保存新token到缓存
   ↓
6. 返回有效的token
```

### 缓存同步流程

```
1. 获取有效的user_access_token（自动刷新）
   ↓
2. 创建缓存管理器实例
   ↓
3. 检查缓存是否过期
   ↓
4. 如果过期或强制刷新，从API获取数据
   ↓
5. 保存数据到本地缓存
   ↓
6. 建立索引（多维表格）
```

---

## 相关文件

### 核心脚本
- `auto_sync_all.py` - 统一自动同步脚本（推荐）
- `auto_sync_bitable.py` - 多维表格自动同步
- `auto_sync_spreadsheet.py` - 在线表格自动同步
- `sync_cache_now.py` - 快速同步脚本

### Token管理
- `token_manager.py` - Token管理器（自动刷新）
- `get_user_token_for_bitable.py` - 获取token授权脚本

### 缓存管理
- `bitable_cache_manager.py` - 多维表格缓存管理器
- `spreadsheet_cache_manager.py` - 在线表格缓存管理器

### 缓存文件位置
- Token缓存：`work/fault_diagnosis_token_cache.json`
- 多维表格缓存：`work/bitable_cache/`
- 在线表格缓存：`work/spreadsheet_cache/`
- 故障定位指引文档缓存：`work/fault_diagnosis_cache/guides/`

---

## 更新记录

- **2026-01-16**：建立自动同步缓存系统（含token自动刷新）
- **2026-01-16**：创建统一同步脚本 `auto_sync_all.py`
- **2026-01-16**：更新所有同步脚本集成token自动刷新功能

---

## 最佳实践

1. **首次使用**：运行授权脚本获取token，然后启动定时同步服务
2. **日常使用**：启动定时同步服务，让系统自动维护缓存
3. **定期检查**：每月检查一次token状态，确保refresh_token未过期
4. **故障恢复**：如果同步失败，先检查token，再检查网络和配置

---

## 注意事项

1. **Token有效期**：
   - `access_token`：2小时
   - `refresh_token`：14天
   - 系统会在过期前5分钟自动刷新

2. **同步间隔**：
   - 默认1小时
   - 可根据需要调整
   - 建议不要设置过短（避免API限流）

3. **缓存过期**：
   - 默认缓存有效期1小时
   - 使用 `--force` 可强制刷新

4. **权限要求**：
   - 确保应用有相应的权限（多维表格、在线表格等）
   - 参考相关权限设置文档
