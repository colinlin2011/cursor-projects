# 对话记录：故障概况提取能力开发

**对话日期**：2026-01-16  
**对话类型**：能力开发/功能增强  
**主要任务**：开发故障概况提取能力，整合多个数据源生成综合故障概况  
**最后更新**：2026-01-16（优化查询顺序和专家分析）

---

## 对话背景

用户需要建立一个故障概况提取能力，能够从多个数据源（故障定位指引文档、"06. 安全需求总表"多维表格、功能安全业务数据）中整合提取fa_id相关信息，生成综合故障概况。

---

## 对话过程

### 阶段1：初始需求

**用户需求**：
1. 除了查询"故障定位指引文档"，还要从"功能安全业务数据"多维表格的"06. 安全需求总表"内容进行匹配
2. 将这种问答逻辑封装成能力，在log数据提取fa_id后，能够借助这个能力提取回复内容，并输出"故障概况"

**实现方案**：
- 创建`FaultSummaryExtractor`类，整合三个数据源
- 集成到`SSHLogQueryEngine.query_setfunc_fault()`方法中
- 注册为SKILL-009能力

### 阶段2：问题发现与修复

**问题1**：测试时未找到任何信息
- **原因**：Python脚本无法像AI一样理解语义信息，表名不完全匹配，fa_id匹配逻辑不够智能
- **解决方案**：
  1. 表名模糊匹配：支持查找包含"06. 安全需求总表"的表名
  2. 指引文档内容搜索：在文档内容中直接搜索fa_id的多种变体
  3. 记录匹配优化：将整个记录转换为JSON文本进行搜索
  4. 数据结构兼容：支持字典和列表两种缓存数据格式

**问题2**：输出信息冗余
- **原因**：直接提取缓存信息，没有去重和格式化
- **解决方案**：
  1. 去重逻辑：相同fa_id的记录只保留唯一组合
  2. 描述清理：去除重复段落，只保留核心描述
  3. 字段优化：只提取关键字段（故障名称、ASIL等级、涉及模块、触发条件等）
  4. 结构化输出：生成清晰的分类信息

### 阶段3：AI总结能力集成

**用户需求**：使用AI问答能力进行汇总总结，增强易读性

**实现方案**：
- 生成AI总结提示词，可在Cursor中使用AI进行智能总结
- 优化信息提取，去除冗余，只保留关键信息
- 生成结构化的、易读的总结文本

### 阶段4：数据源澄清与优化

**用户澄清**：
1. "功能安全业务数据"是一个多维表格，包含14个表
2. 其中"06. 安全需求总表(同步Polarion Safety空间需求"就是我们要查询的表
3. 当说在"功能安全业务数据"里查询时，确切是指在这个表中查询

**优化方案**：
- 移除对`FaultSummaryGrep`的依赖（不再遍历所有14个表）
- 步骤3直接使用步骤2中已查询的"06. 安全需求总表"数据

### 阶段5：使用table_id定位表

**用户需求**：表名可能会改，请使用表的全局地址来定位

**实现方案**：
- 添加table_id支持：`tbl3akMZjFE962Db`
- 优先使用table_id查询（比表名更可靠）
- 保留表名查询作为备用方案

---

## 技术实现

### 创建的文件

1. **`fault_summary_extractor.py`** - 核心实现
   - `FaultSummaryExtractor`类：故障概况提取器
   - `extract_fault_summary()`：提取故障概况
   - `generate_ai_summary()`：生成AI总结提示词
   - `_query_safety_requirement_table()`：查询安全需求总表
   - `_search_guide_by_content()`：在指引文档内容中搜索
   - `_extract_key_info_from_matches()`：提取关键信息（去重、去冗余）
   - `_generate_summary_text()`：生成结构化总结文本
   - `_generate_ai_summary_prompt()`：生成AI总结提示词

2. **`fault-summary-extractor.md`** - 能力定义文档

3. **`test_fault_summary_extractor.py`** - 测试脚本

4. **`test_ai_summary.py`** - AI总结测试脚本

### 修改的文件

1. **`ssh_log_query_engine.py`**
   - 集成故障概况提取到`query_setfunc_fault()`方法
   - 在JSON和文本输出中都包含故障概况

2. **`bitable_query_interface.py`**
   - 添加`table_id`参数支持
   - 优先使用table_id查询

3. **`registry.md`**
   - 注册SKILL-009能力
   - 更新能力统计和历史

### 核心功能

1. **多源信息整合**
   - 故障定位指引文档
   - "06. 安全需求总表"多维表格
   - 功能安全业务数据（实际就是安全需求总表）

2. **智能查询**
   - 表名模糊匹配
   - table_id优先查询
   - 指引文档内容搜索
   - 记录智能匹配

3. **信息优化**
   - 去重逻辑
   - 描述清理
   - 关键字段提取

4. **AI总结支持**
   - 生成结构化提示词
   - 可在Cursor中使用AI总结

---

## 关键决策

### 决策1：使用table_id而不是表名
- **原因**：表名可能会变更，table_id更稳定
- **实现**：优先使用table_id查询，表名作为备用

### 决策2：整合数据源
- **原因**："功能安全业务数据"就是"06. 安全需求总表"，不需要重复查询
- **实现**：步骤3直接使用步骤2的数据

### 决策3：生成AI总结提示词
- **原因**：用户希望使用AI问答能力进行汇总总结
- **实现**：生成结构化的提示词，可在Cursor中使用

---

## 工作成果

### 完成的功能

1. ✅ 故障概况提取能力（SKILL-009）
2. ✅ 多源信息整合（指引文档、安全需求总表）
3. ✅ 智能查询（模糊匹配、内容搜索、语义搜索）
4. ✅ 信息优化（去重、去冗余）
5. ✅ AI总结支持（生成提示词）
6. ✅ table_id支持（避免表名变更影响）
7. ✅ 语义搜索（基于安全需求总表信息在指引文档中搜索）
8. ✅ 专家分析（基于专家认知生成可能的原因分析）

### 测试验证

- ✅ 成功提取0x0165的故障概况
- ✅ 成功找到安全需求总表信息（4条匹配记录）
- ✅ 成功在指引文档内容中找到fa_id引用
- ✅ 成功生成AI总结提示词

---

## 经验教训

### 技术经验

1. **语义理解vs精确匹配**
   - 问题：Python脚本无法像AI一样理解语义
   - 解决：使用模糊匹配、内容搜索、智能匹配等多种方式

2. **数据源整合**
   - 问题：多个数据源可能有重复
   - 解决：明确数据源关系，避免重复查询

3. **表定位方式**
   - 问题：表名可能变更
   - 解决：使用table_id作为主要定位方式

### 工作模式

1. **迭代优化**：从发现问题到逐步优化，形成闭环
2. **用户反馈驱动**：根据用户反馈不断改进
3. **多方案备选**：提供多种查询方式，提高容错性
4. **语义理解优先**：先获取结构化信息，再基于语义进行搜索
5. **专家知识集成**：结合领域专家认知，提供原因分析

---

## 后续建议

### 短期优化

1. 优化AI总结提示词格式，使其更易用
2. 添加更多测试用例，验证不同fa_id的提取效果
3. 优化输出格式，提高可读性

### 长期规划

1. 考虑直接集成AI API，实现自动总结
2. 扩展数据源，整合更多故障相关信息
3. 建立故障知识图谱，实现更智能的关联查询

---

## 相关文件

- `capabilities/skills/skills/fault_summary_extractor.py` - 核心实现
- `capabilities/skills/skills/fault-summary-extractor.md` - 能力定义
- `capabilities/skills/skills/test_fault_summary_extractor.py` - 测试脚本
- `capabilities/skills/skills/test_ai_summary.py` - AI总结测试
- `capabilities/registry.md` - 能力注册表
- `capabilities/skills/skills/ssh_log_query_engine.py` - SSH日志查询引擎（已集成）

---

## 记忆提取

### 状态层
- 当前工作：故障概况提取能力开发
- 完成状态：已完成并测试通过

### 情境层
- 工作背景：故障分析工作流优化
- 技术环境：Python、飞书API、多维表格缓存

### 行为层
- 开发行为：创建新能力、集成现有系统、优化查询逻辑
- 问题解决：发现并修复多个问题，迭代优化

### 认知层
- 思维模式：从用户需求出发，逐步完善功能
- 决策框架：优先使用稳定标识（table_id），提供多种备选方案

### 核心层
- 工作原则：专业精准、场景化应对、持续优化
- 价值体现：提高故障分析效率，整合多源信息

---

**记录时间**：2026-01-16  
**最后更新**：2026-01-16（优化查询顺序和专家分析）  
**记录人**：AI as me  
**对话状态**：已完成
